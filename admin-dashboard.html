<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ - ë™ë¬¼ ì´ˆì„± ë¹™ê³ </title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="dashboard">
            <div class="card">
                <div class="dashboard-header">
                    <div class="dashboard-title">
                        <span style="font-size: 2rem;">ğŸ”</span>
                        <div>
                            <h2>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>
                            <p>íšŒì› ê°€ì… ìŠ¹ì¸ ê´€ë¦¬</p>
                        </div>
                    </div>
                    <div class="dashboard-actions">
                        <button class="btn btn-ghost" onclick="logout()">
                            <span>ğŸšª</span>
                            <span>ë¡œê·¸ì•„ì›ƒ</span>
                        </button>
                    </div>
                </div>

                <!-- ëŒ€ê¸° ì¤‘ì¸ íšŒì› -->
                <div class="section" style="margin-bottom: 1.5rem;">
                    <div class="section-header">
                        <span>â³</span>
                        <span>ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ (<span id="pendingCount">0</span>ëª…)</span>
                    </div>
                    <div id="pendingList" class="player-list">
                        <div class="empty-state">
                            <p>ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>

                <!-- ìŠ¹ì¸ëœ íšŒì› -->
                <div class="section">
                    <div class="section-header">
                        <span>âœ…</span>
                        <span>ìŠ¹ì¸ëœ íšŒì› (<span id="approvedCount">0</span>ëª…)</span>
                    </div>
                    <div id="approvedList" class="player-list">
                        <div class="empty-state">
                            <p>ìŠ¹ì¸ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCCuAOnkEmfFEE57D3bgWLU7xR2f0i2psI",
            authDomain: "animal-bingo-90774.firebaseapp.com",
            databaseURL: "https://animal-bingo-90774-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "animal-bingo-90774",
            storageBucket: "animal-bingo-90774.firebasestorage.app",
            messagingSenderId: "547100283990",
            appId: "1:547100283990:web:d1206d278a9f46eaf2d7f7",
            measurementId: "G-E8WLHPJ24E"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ë¡œê·¸ì¸ í™•ì¸
        if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
            alert('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            location.href = 'admin-login.html';
        }

        // íšŒì› ëª©ë¡ ë¡œë“œ
        function loadUsers() {
            database.ref('users').on('value', (snapshot) => {
                const users = snapshot.val() || {};
                const userArray = Object.entries(users).map(([id, data]) => ({
                    id,
                    ...data
                }));

                const pending = userArray.filter(u => u.status === 'pending');
                const approved = userArray.filter(u => u.status === 'approved');

                renderPendingUsers(pending);
                renderApprovedUsers(approved);
            });
        }

        // ëŒ€ê¸° ì¤‘ì¸ íšŒì› ë Œë”ë§
        function renderPendingUsers(users) {
            const pendingList = document.getElementById('pendingList');
            const pendingCount = document.getElementById('pendingCount');

            pendingCount.textContent = users.length;

            if (users.length === 0) {
                pendingList.innerHTML = '<div class="empty-state"><p>ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>';
            } else {
                pendingList.innerHTML = users.map(user => `
                    <div class="answer-item" style="flex-direction: column; align-items: stretch;">
                        <div class="answer-content" style="margin-bottom: 1rem;">
                            <div style="display: flex; flex-direction: column;">
                                <span class="answer-word">${user.name}</span>
                                <span class="answer-info">ì•„ì´ë””: ${user.username}</span>
                                <span class="answer-info" style="font-size: 0.75rem; color: #64748b;">ê°€ì…ì¼: ${new Date(user.createdAt).toLocaleString('ko-KR')}</span>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-size: 0.875rem; color: #cbd5e1; white-space: nowrap;">ì‚¬ìš© ê¸°ê°„:</label>
                                <select id="period-${user.id}" style="flex: 1; padding: 0.5rem; background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 0.5rem; color: white; cursor: pointer;">
                                    <option value="7">7ì¼</option>
                                    <option value="30" selected>30ì¼ (1ê°œì›”)</option>
                                    <option value="90">90ì¼ (3ê°œì›”)</option>
                                    <option value="180">180ì¼ (6ê°œì›”)</option>
                                    <option value="365">365ì¼ (1ë…„)</option>
                                    <option value="9999">ë¬´ì œí•œ</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="approveUser('${user.id}')" style="flex: 1; padding: 0.5rem 1rem; background: #10b981; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">
                                    âœ… ìŠ¹ì¸
                                </button>
                                <button onclick="rejectUser('${user.id}')" style="flex: 1; padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">
                                    âŒ ê±°ë¶€
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // ìŠ¹ì¸ëœ íšŒì› ë Œë”ë§
        function renderApprovedUsers(users) {
            const approvedList = document.getElementById('approvedList');
            const approvedCount = document.getElementById('approvedCount');

            approvedCount.textContent = users.length;

            if (users.length === 0) {
                approvedList.innerHTML = '<div class="empty-state"><p>ìŠ¹ì¸ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>';
            } else {
                approvedList.innerHTML = users.map(user => {
                    const expiryDate = user.expiryDate ? new Date(user.expiryDate) : null;
                    const isExpired = expiryDate && expiryDate < new Date();
                    const expiryText = user.expiryDate === 'unlimited' ? 'ë¬´ì œí•œ' : 
                                      expiryDate ? expiryDate.toLocaleDateString('ko-KR') : 'ì„¤ì • ì•ˆë¨';
                    
                    return `
                    <div class="answer-item" style="flex-direction: column; align-items: stretch; ${isExpired ? 'opacity: 0.6; border: 1px solid #ef4444;' : ''}">
                        <div class="answer-content" style="margin-bottom: 0.75rem;">
                            <div style="display: flex; flex-direction: column;">
                                <span class="answer-word">${user.name} ${isExpired ? '<span style="color: #ef4444; font-size: 0.875rem;">(ë§Œë£Œë¨)</span>' : ''}</span>
                                <span class="answer-info">ì•„ì´ë””: ${user.username}</span>
                                <span class="answer-info" style="font-size: 0.75rem; color: #64748b;">ìŠ¹ì¸ì¼: ${new Date(user.approvedAt || user.createdAt).toLocaleString('ko-KR')}</span>
                                <span class="answer-info" style="font-size: 0.75rem; color: ${isExpired ? '#ef4444' : '#10b981'};">
                                    ë§Œë£Œì¼: ${expiryText}
                                </span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="extendPeriod('${user.id}')" style="flex: 1; padding: 0.5rem 1rem; background: #06b6d4; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600; font-size: 0.875rem;">
                                ğŸ”„ ê¸°ê°„ ì—°ì¥
                            </button>
                            <button onclick="revokeUser('${user.id}')" style="padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600; font-size: 0.875rem;">
                                ğŸš« ìŠ¹ì¸ ì·¨ì†Œ
                            </button>
                        </div>
                    </div>
                `}).join('');
            }
        }

        // ìŠ¹ì¸
        window.approveUser = function(userId) {
            const periodSelect = document.getElementById(`period-${userId}`);
            const days = parseInt(periodSelect.value);
            
            if (confirm(`ì´ íšŒì›ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚¬ìš© ê¸°ê°„: ${days === 9999 ? 'ë¬´ì œí•œ' : days + 'ì¼'}`)) {
                let expiryDate;
                if (days === 9999) {
                    expiryDate = 'unlimited';
                } else {
                    const expiry = new Date();
                    expiry.setDate(expiry.getDate() + days);
                    expiryDate = expiry.getTime();
                }

                database.ref(`users/${userId}`).update({
                    status: 'approved',
                    approvedAt: Date.now(),
                    expiryDate: expiryDate,
                    periodDays: days
                }).then(() => {
                    alert('ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                }).catch((error) => {
                    alert('ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                });
            }
        };

        // ê¸°ê°„ ì—°ì¥
        window.extendPeriod = function(userId) {
            const days = prompt('ì—°ì¥í•  ê¸°ê°„ì„ ì…ë ¥í•˜ì„¸ìš” (ì¼):\n\nì˜ˆì‹œ:\n- 30 (30ì¼)\n- 365 (1ë…„)\n- 9999 (ë¬´ì œí•œ)', '30');
            
            if (days === null) return;
            
            const daysNum = parseInt(days);
            if (isNaN(daysNum) || daysNum < 1) {
                alert('ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            database.ref(`users/${userId}`).once('value', (snapshot) => {
                const user = snapshot.val();
                let newExpiryDate;

                if (daysNum === 9999) {
                    newExpiryDate = 'unlimited';
                } else {
                    const currentExpiry = user.expiryDate === 'unlimited' ? new Date() : 
                                         user.expiryDate ? new Date(user.expiryDate) : new Date();
                    
                    // í˜„ì¬ ë‚ ì§œë³´ë‹¤ ì´ì „ì´ë©´ í˜„ì¬ ë‚ ì§œë¶€í„°, ì•„ë‹ˆë©´ ë§Œë£Œì¼ë¶€í„° ì—°ì¥
                    const baseDate = currentExpiry < new Date() ? new Date() : currentExpiry;
                    baseDate.setDate(baseDate.getDate() + daysNum);
                    newExpiryDate = baseDate.getTime();
                }

                database.ref(`users/${userId}`).update({
                    expiryDate: newExpiryDate,
                    lastExtended: Date.now()
                }).then(() => {
                    alert(`ì‚¬ìš© ê¸°ê°„ì´ ${daysNum === 9999 ? 'ë¬´ì œí•œìœ¼ë¡œ' : daysNum + 'ì¼'} ì—°ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                }).catch((error) => {
                    alert('ê¸°ê°„ ì—°ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                });
            });
        };

        // ê±°ë¶€
        window.rejectUser = function(userId) {
            if (confirm('ì´ íšŒì›ì„ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤)')) {
                database.ref(`users/${userId}`).remove();
            }
        };

        // ìŠ¹ì¸ ì·¨ì†Œ
        window.revokeUser = function(userId) {
            if (confirm('ìŠ¹ì¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                database.ref(`users/${userId}`).update({
                    status: 'pending'
                });
            }
        };

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            sessionStorage.removeItem('adminLoggedIn');
            location.href = 'index.html';
        }

        // ì´ˆê¸° ë¡œë“œ
        loadUsers();
    </script>
</body>
</html>
